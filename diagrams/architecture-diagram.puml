@startuml KiteClass Platform Architecture
!theme plain
skinparam linetype ortho
skinparam rectangle {
    BackgroundColor<<kitehub>> #E3F2FD
    BackgroundColor<<kiteclass>> #E8F5E9
    BackgroundColor<<aws>> #FFF3E0
    BorderColor #424242
    FontSize 11
}

title KiteClass Platform - System Architecture V2

' Users
actor "Users\n(Students/Instructors)" as users #lightblue

' AWS Edge Services
rectangle "Route 53\n(DNS)" as route53 <<aws>> #FFE0B2
rectangle "CloudFront\n(CDN)" as cloudfront <<aws>> #FFE0B2
rectangle "Application\nLoad Balancer" as alb <<aws>> #FFE0B2

' EKS Cluster
package "AWS EKS Cluster" {

    ' KiteHub Namespace
    package "KiteHub Namespace\n(Modular Monolith)" <<kitehub>> {
        rectangle "Sale Module\n[Java Spring Boot]\n- Order management\n- Payment processing" as sale #BBDEFB
        rectangle "Message Module\n[Node.js]\n- Chat/Notification\n- WebSocket" as message #BBDEFB
        rectangle "Maintaining Module\n[Java Spring Boot]\n- Instance provisioning\n- Monitoring" as maintain #BBDEFB
        rectangle "AI Agent Module\n[Python FastAPI]\n- Generate branding\n- Image/text AI" as ai #BBDEFB
    }

    ' KiteClass Instance
    package "KiteClass Instance #1\n(Microservices)" <<kiteclass>> {
        rectangle "Main Class Service\n[Java]" as mainclass #C8E6C9
        rectangle "User Service\n[Java]" as user #C8E6C9
        rectangle "CMC Service\n[Java]" as cmc #C8E6C9
        rectangle "Video Service\n[Java]" as video #C8E6C9
        rectangle "Streaming Service\n[Node.js]" as streaming #C8E6C9
        rectangle "Forum Service\n[Java]" as forum #C8E6C9
        rectangle "Frontend\n[Next.js SSR]" as frontend #C8E6C9
    }

    package "KiteClass Instance #N\n..." <<kiteclass>> {
        rectangle "Services..." as more #C8E6C9
    }
}

' Database Layer
database "Aurora PostgreSQL\nServerless v2\n(Per-instance DB)" as aurora <<aws>> #FFE0B2
database "ElastiCache\nRedis\n(Shared)" as redis <<aws>> #FFE0B2
storage "S3 Buckets\n- Assets\n- Videos\n- AI-generated" as s3 <<aws>> #FFE0B2
queue "SQS\nMessage Queue" as sqs <<aws>> #FFE0B2

' External AI Services
cloud "AI Services" as aiservices {
    rectangle "OpenAI GPT-4" as gpt4 #FFF9C4
    rectangle "Stable Diffusion\nXL" as sd #FFF9C4
    rectangle "Remove.bg" as removebg #FFF9C4
}

' Connections - User Flow
users --> route53
route53 --> cloudfront
cloudfront --> alb

' ALB to services
alb --> sale
alb --> frontend

' KiteHub connections
sale ..> maintain : Provision request
sale ..> ai : Generate assets
ai --> aiservices : API calls
ai --> s3 : Upload assets
maintain --> sqs : Queue jobs

' Frontend to Backend
frontend --> mainclass : REST API
frontend --> user : REST API
frontend --> cmc : REST API

' Services to Database
mainclass --> aurora
user --> aurora
cmc --> aurora
video --> s3
streaming --> redis

sale --> aurora : KiteHub DB
maintain --> aurora : KiteHub DB

' Notes
note right of ai
  **AI Agent Features:**
  - Background removal
  - Color extraction
  - Generate marketing copy
  - Create banners/logos
  Cost: $0.19/instance
end note

note right of frontend
  **Shared Codebase**
  Per-instance deployment
  Auto-apply AI branding
end note

note bottom of aurora
  **Multi-tenant Strategy**
  1 database per KiteClass instance
  Auto-scaling: 0.5-4 ACU
end note

@enduml
